<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>

  <!-- ✅ Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet" />

  <!-- ✅ Bootstrap & FontAwesome CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="assets/css/templatemo-scholar.css" />
  <link rel="stylesheet" href="assets/css/owl.css" />
  <link rel="stylesheet" href="assets/css/animate.css" />
  <link rel="stylesheet" href="https://unpkg.com/swiper@7/swiper-bundle.min.css" />

  
    <style>
      h6 { color: #7a6ad8; }
      button { color: #7a6ad8; }
      p { color: white; }
      a {
        color: aliceblue;
        text-decoration: underline;
      }
      h2,h4{
        color: antiquewhite;
      }

      .gallery-thumb {
        width: 200px;
        height: 140px;
        border-radius: 8px;
        display: flex;
        align-items: flex-start;
      }

      h4 {
       color: antiquewhite;
       margin-top: 20px;
      }
      
      .swiper-button-next, .swiper-button-prev {
  color: #6c63ff;
  top: 50%;
  transform: translateY(-50%);
  width: 30px;
  height: 30px;
 
}

.swiper-button-prev {
  left: 200px;
}

.swiper-button-next {
  right: 820px;
}

@media (max-width: 768px) {
  .swiper-button-prev {
    left: 5px;
  }

  .swiper-button-next {
    right: 5px;
  }
}

/* Hide prev/next buttons unless hovered (desktop only) */
#galleryList .swiper {
  max-width: 220px;
  margin: 0;
  position: relative;
}

#galleryList .swiper-button-next,
#galleryList .swiper-button-prev {
  display: none !important;
}


    </style>
  
</head>
<body>


  <!--navbar jyothis-->
<!-- Header -->
  <header class="header-area header-sticky">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <nav class="main-nav">
            <a href="index.html" class="logo"><h1>Jyothis</h1></a>
              <ul class="nav">
              <li><a href="index.html" class="active">Home</a></li>
              <li><a href="#contact" onclick="logout()">Log Out</a></li>
            </ul>
            <a class='menu-trigger'>
            <span>Menu</span>
            </a>
          </nav>
        </div>
      </div>
    </div>
  </header>

  <!-- course form Section -->
  <div class="main-banner" id="top">
    <div class="container">
      <div class="row">
        <!-- Welcome Text -->
        <div class="col-lg-6 align-self-center">
          <div class="mt-3 p-4 shadow rounded-4">
            <h2 class="text-center mb-4">Hi Admin!!</h2>
          </div>
        </div>

        <!-- Add course Form -->
        <div class="col-lg-6">
          <div class="card p-4 shadow rounded-4">
            <h6 class="text-center mb-4">Add Course</h6>
            <div id="msg" class="text-danger text-center mb-3"></div>
            <form id="courseForm" enctype="multipart/form-data">
              <div class="mb-3">
                <h6><label class="form-label">Course Title</label></h6>
                <input type="text" class="form-control" name="title" required />
              </div>
              <div class="mb-3">
                <h6><label  class="form-label">Course Description</label></h6>
                <textarea class="form-control" name="description" rows="3" required></textarea>
              </div>
              <div class="mb-3">
              <h6><label class="form-label">Course Image</label></h6>
              <input type="file" class="form-control" name="image" accept="image/*" />
              </div>

              <div class="main-button">
                <button type="submit" class="btn btn-outline-dark w-100"><h6>Add </h6></button>
              </div>
            </form>
          </div>
        </div>
        <!--add to gallery-->
        <!-- Gallery Upload -->
<div class="col-lg-6 mt-5">
  <div class="card p-4 shadow rounded-4">
    <h6 class="text-center mb-4">Add to Gallery</h6>
    <form id="galleryForm" enctype="multipart/form-data">
      <div class="mb-3">
        <h6><label class="form-label">Title</label></h6>
        <input type="text" class="form-control" name="title" required />
      </div>
      <div class="mb-3">
        <h6><label class="form-label">Type</label></h6>
        <select name="type" class="form-select" required>
          <option value="image">Image</option>
          <option value="video">Video</option>
          <option value="album">Album</option>
        </select>
      </div>
      <div class="mb-3">
        <h6><label class="form-label">Album (optional)</label></h6>
        <input type="text" class="form-control" name="album" />
      </div>
      <div class="mb-3">
        <h6><label class="form-label">Media File</label></h6>
        <input type="file" class="form-control" name="media" accept="image/*,video/*" multiple required />
      </div>
      <div class="main-button">
        <button type="submit" class="btn btn-outline-dark w-100"><h6>Upload</h6></button>
      </div>
    </form>
  </div>
</div>


</div>


      <div class="row" >
         <!-- Course List -->
        <h4>Available Courses</h4>
        <ul id="courseList" class="list-group"></ul>
      </div>
      <!-- Gallery List -->
      <div class="row mt-4">
      <h4>Gallery Items</h4>
      <ul id="galleryList" class="list-group"></ul>
</div>

    </div>
  </div>


   
  <!-- jQuery + Bootstrap JS -->
  <script src="vendor/jquery/jquery.min.js"></script>

  <!-- Admin Script -->

  <script>
  const COURSE_API = 'https://jyothis-backend.onrender.com/api/courses';
  const token = localStorage.getItem('token');
  const role = localStorage.getItem('role');

  let editingCourseId = null;

  if (role !== 'admin' || !token) {
    window.location.href = "login.html";
  }

  function logout() {
    localStorage.clear();
    window.location.href = "login.html";
  }

 $('#courseForm').submit(function (e) {
  e.preventDefault();

  const formData = new FormData(this);
  const url = editingCourseId ? `${COURSE_API}/${editingCourseId}` : `${COURSE_API}/add`;

  const method = editingCourseId ? 'PUT' : 'POST';

  $.ajax({
    url: url,
    method: method,
    data: formData,
    headers: {
      'Authorization': 'Bearer ' + token
    },
    contentType: false,
    processData: false,
    success: function () {
      alert(editingCourseId ? "Course updated!" : "Course added!");
      $('#courseForm')[0].reset();
      editingCourseId = null;
      $('button[type="submit"]').html('<h6>Add</h6>'); 
      loadCourses();
    },
    error: function (err) {
      alert("Error: " + err.responseText);
    }
  });
});

function loadCourses() {
  $.ajax({
    url: COURSE_API,
    method: 'GET',
    headers: {
      'Authorization': 'Bearer ' + token
    },
    success: function (courses) {
      let html = '';
      courses.forEach(course => {

      const imageUrl = course.image && course.image.includes('cloudinary.com')
      ? course.image
      : course.image
      ? `https://jyothis-backend.onrender.com/uploads/${course.image}`
      : 'https://res.cloudinary.com/dltbu7m2e/image/upload/v1752920252/default_course_tdw2si.avif';


        html += `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <img src="${imageUrl}"  alt="course image" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-right: 15px;" />
              <div>
                <strong>${course.title}</strong><br/>
                <small>${course.description}</small>
              </div>
            </div>
            <div>
              <button class="btn btn-outline-warning me-2" onclick="editCourse('${course._id}', '${course.title}', \`${course.description.replace(/`/g, '\\`')}\`)">Edit</button>
              <button class="btn btn-outline-danger" onclick="deleteCourse('${course._id}')">Delete</button>
            </div>
          </li>
        `;
      });
      $('#courseList').html(html); // Add this to display the courses
    },
    error: function () {
      alert("Failed to load courses.");
    }
  });
}
  


function deleteCourse(id) {
    $.ajax({
      url: COURSE_API + '/' + id,
      method: 'DELETE',
      headers: {
        'Authorization': 'Bearer ' + token
      },
      success: function () {
        alert("Course deleted.");
        loadCourses();
      },
      error: function () {
        alert("Could not delete course.");
      }
    });
  }

  function editCourse(id, title, description) {
    editingCourseId = id;
    $('[name="title"]').val(title);
    $('[name="description"]').val(description);
    $('button[type="submit"]').html('<h6>Update</h6>');
  }

  // Load courses on page load
  loadCourses();

const GALLERY_API = 'https://jyothis-backend.onrender.com/api/gallery';

$('#galleryForm').submit(function (e) {
  e.preventDefault();

  const formData = new FormData();
  const title = $('#galleryForm [name="title"]').val();
  const album = $('#galleryForm [name="album"]').val();
  const files = $('#galleryForm [name="media"]')[0].files;
  let type = $('#galleryForm [name="type"]').val();

  if (files.length > 1 && type === 'image') {
    type = 'album';
  }

  formData.append("title", title.trim() || "Untitled");
  formData.append("type", type);
  if (album) formData.append("album", album);

  for (let i = 0; i < files.length; i++) {
    formData.append("media", files[i]);
  }

  $.ajax({
    url: GALLERY_API,
    method: 'POST',
    data: formData,
    headers: {
      'Authorization': 'Bearer ' + token
    },
    contentType: false,
    processData: false,
    success: function () {
      alert("Media uploaded to gallery!"); 
      $('#galleryForm')[0].reset();
      loadGallery();
    },
    error: function (err) {
      alert("Gallery upload failed: " + err.responseText);
      console.log("Upload debug:", err);
    }
  });
});



function loadGallery() {
  $.ajax({
    url: GALLERY_API,
    method: 'GET',
    success: function (items) {
      let html = '';
      items.forEach((item, index) => {
        html += `<li class="list-group-item">`;

        if (item.type === 'album') {
          html += `
          <div>
           <strong>${item.title && item.title.trim() ? item.title : 'Untitled'}</strong> 
           <span class="text-muted">(${item.type})</span>
          </div>

          <div class="d-flex align-items-center">
             <div class="swiper mySwiper-${index} album-admin-preview" data-images='${JSON.stringify(item.images)}'>
                <div class="swiper-wrapper">
                  ${item.images.map(url => `
                    <div class="swiper-slide">
                      <img src="${url}" class="gallery-thumb" />
                    </div>`).join('')}
                </div>
                <div class="swiper-button-prev swiper-button-prev-${index}"></div>
                <div class="swiper-button-next swiper-button-next-${index}"></div>
              </div>
              <div class="ms-auto">
                <button class="btn btn-outline-danger" onclick="deleteGallery('${item._id}')">Delete</button>
              </div>
            </div>
          `;
      } else {
  const safeTitle = item.title && item.title.trim() ? item.title : 'Untitled';

  html += `
    <div class="mb-2">
      <strong>${safeTitle}</strong>
      <span class="text-muted">(${item.type})</span>
    </div>
    <div>
      ${item.type === 'image'
        ? `<img src="${item.url}" class="gallery-thumb" />`
        : `<video controls class="gallery-thumb"><source src="${item.url}" type="video/mp4" /></video>`}
    </div>
    <div class="d-flex justify-content-end mt-2">
      <button class="btn btn-outline-danger" onclick="deleteGallery('${item._id}')">Delete</button>
    </div>
  `;
}


        html += `</li>`;
      });

      $('#galleryList').html(html);

      items.forEach((item, index) => {
        if (item.type === 'album') {
          new Swiper(`.mySwiper-${index}`, {
            navigation: {
              nextEl: `.swiper-button-next-${index}`,
              prevEl: `.swiper-button-prev-${index}`
            },
            loop: true,
            spaceBetween: 10
          });
        }
      });
    }
  });
}



function deleteGallery(id) {
  if (!confirm("Are you sure you want to delete this item?")) return;

  const token = localStorage.getItem("token");

fetch(`${GALLERY_API}/${id}`, {
    method: "DELETE",
    headers: {
      Authorization: `Bearer ${token}`
    }
  })
    .then(res => {
      if (!res.ok) throw new Error("Failed to delete");
      return res.json();
    })
    .then(() => {
      alert("Deleted successfully");
      loadGallery(); // Refresh gallery list
    })
    .catch(err => {
      alert("Error deleting item");
      console.error(err);
    });
}


loadGallery();


</script>

<!-- ✅ jQuery (needed if you're using custom menu behavior) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- ✅ Bootstrap JS Bundle (includes Popper.js) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // ✅ Scholar template menu trigger functionality
  $(".menu-trigger").on("click", function () {
    $(this).toggleClass("active");
    $(".main-nav ul").slideToggle(200);
  });

  // Optional: Hide nav menu on link click (for small screens)
  $(".main-nav ul li a").on("click", function () {
    $(".menu-trigger").removeClass("active");
    $(".main-nav ul").slideUp(200);
  });




  $(window).on('resize', function () {
  if ($(window).width() >= 992) {
    $('.main-nav .nav').show(); // show nav on large screens
  } else {
    if (!$('.menu-trigger').hasClass('active')) {
      $('.main-nav .nav').hide(); // hide nav if menu is not toggled
    }
  }
});


function toggleLike(icon) {
  if (icon.classList.contains('fa-regular')) {
    icon.classList.remove('fa-regular');
    icon.classList.add('fa-solid', 'text-danger'); // filled red heart
  } else {
    icon.classList.remove('fa-solid', 'text-danger');
    icon.classList.add('fa-regular'); // outline
  }
}

</script>
<script src="https://unpkg.com/swiper@7/swiper-bundle.min.js"></script>
<script>
$(document).on('click', '.album-admin-preview', function () {
  const images = JSON.parse($(this).attr('data-images'));
  const slides = images.map(img => `<img src="${img}" style="max-width:90%;margin:20px auto;display:block;border-radius:10px;" />`).join("");

  const viewer = `
    <div id="adminAlbumModal" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#000c;z-index:9999;overflow:auto;padding:40px;text-align:center;">
      ${slides}
      <span onclick="$('#adminAlbumModal').remove();" style="position:fixed;top:15px;right:25px;font-size:35px;color:white;cursor:pointer;">✕</span>
    </div>
  `;

  $('body').append(viewer);
});
</script>

</body>
</html>
